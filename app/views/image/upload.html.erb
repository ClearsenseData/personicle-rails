<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Testing File Uploads</title>
    <link
      href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <section
      class="max-w-4xl mt-4 w-11/12 mx-auto bg-blue-50 p-8 shadow-lg rounded-lg"
    >
      <h1 class="text-3xl font-semibold text-center">Add an Image</h1>
      <form>
        <fieldset class="my-2">
          <label class="w-full block uppercase ml-3 mb-3" for="individual_id">
            <%# Individual Id %>
          </label>
          <input
            type="hidden"
            name="individual_id"
            id="individual_id"
            class="w-full block p-3 shadow-sm"
            placeholder="Individual Id"
            value = "<%= session[:oktastate]['uid']%>"
        
          />
           <input
            type="hidden"
            name="session"
            id="session"
            class="w-full block p-3 shadow-sm"
            value = "<%= session[:oktastate]['credentials']['token']%>"
          />
        </fieldset>
        <fieldset class="my-2">
          <label class="w-full block uppercase ml-3 mb-3" for="timestamp">
            Time
          </label>
          <input
            type="datetime-local"
            name="timestamp"
            id="timestamp"
            class="w-full block p-3 shadow-sm"
          />
        </fieldset>
        <%# <fieldset class="my-2">
          <label class="w-full block uppercase ml-3 mb-3" for="end_time">
            End Time
          </label>
          <input
            type="datetime-local"
            name="end_time"
            id="end_time"
            class="w-full block p-3 shadow-sm"
          />
        </fieldset> %>
        <%# <fieldset class="my-2">
          <label class="w-full block uppercase ml-3 mb-3" for="location">
            Location
          </label>
          <input
            type="text"
            name="location"
            id="location"
            class="w-full block p-3 shadow-sm"
            placeholder="Location"
          />
        </fieldset> %>
        <fieldset class="my-2">
          <label class="w-full block uppercase ml-3 mb-0" for="image">
            Image
          </label>
          <input
            type="file"
            name="image"
            id="image"
            class="w-full block p-3"
            placeholder="image"
            multiple
          />
        </fieldset>
        <button
          class="w-full block p-3 bg-green-400 hover:bg-green-500 text-center transition duration-200"
          type="submit"
        >
          Upload Image
        </button>
      </form>
    </section>
   
  </body>

  <script type="text/javascript">

  function handleErrors(response) {
    if (!response.ok) {
        throw Error(response.statusText);
    }
    console.log(response);
}

async function getResponse(form,formData) {
	const response = await fetch(
		'https://personicle-file-upload.herokuapp.com/user_images',
		{
			method: 'post',
      body: formData,
			headers: {
		      'Authorization': form.session.value
			}
		}
	);
	if (!response.ok) {
		// throw new Error(`HTTP error! status: ${response.status}`);
    	const data = await response.json();
      console.log(data)
      alert(data)
      return
	}
	// const data = await response.json();
  alert("Image uploaded")
}
    document.addEventListener('DOMContentLoaded', () => {
      const container = document.querySelector('#results')
      document.addEventListener('submit', (e) => {
        e.preventDefault()
        const form = e.target
        const formData = new FormData()
        formData.append('user_image[individual_id]', form.individual_id.value)
        formData.append('user_image[timestamp]', form.timestamp.value)
        // formData.append('event[end_time]', form.end_time.value)
        // formData.append('event[source]', form.source.value)
        // formData.append('user_image[image]', form.image.files[0], form.image.value)
        for (let i = 0; i < form.image.files.length; i++) {
          formData.append(
            'user_image[images][]',
            form.image.files[i],
            form.image.files[i].name
          )
        }


        getResponse(form,formData)
        // fetch('http://localhost:3001/user_images', {
        //   method: 'post',
        //   body: formData,
        //     headers: {
        //     'Authorization': form.session.value
        //    }
        // }).then(handleErrors)
        // .then(response => console.log("ok") )
        // .catch(error => console.log(error) );
          // .then((res) => res.json())
          // .then((event) => {
          //   console.log(event)
          //   // const eventDiv = document.createElement('div')
          //   // eventDiv.className = 'shadow bg-green-50 p-3'
          //   // eventDiv.innerHTML = `
          //   // <h1 class="event-name text-2xl"></h1>
          //   // <img class="event-poster w-full block" />  
          //   // <p class="event-start-time"></p> 
          //   // <p class="event-end-time"></p> 
          //   // <p class="event-location"></p>
          //   // `
          //   // eventDiv.querySelector('.event-name').textContent = event.name
          //   // eventDiv.querySelector('.event-poster').src = event.poster_url
          //   // eventDiv.querySelector('.event-start-time').textContent =event.start_time
          //   // eventDiv.querySelector('.event-end-time').textContent = event.end_time
          //   // eventDiv.querySelector('.event-location').textContent = event.location
  
          //   // container.appendChild(eventDiv)
          // })
      })
    })
  </script>
</html>